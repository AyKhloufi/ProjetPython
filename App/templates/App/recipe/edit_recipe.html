{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% load i18n %}

{% block title %}Modifier {{ recipe.title }} - Mon Site Recettes{% endblock %}

{% block content %}
<div class="edit-recipe-page">
  <!-- Header Section -->
  <div class="page-header mb-4">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <div class="header-content">
          <div class="header-icon mb-3">
            <i class="fas fa-edit fa-3x text-primary"></i>
          </div>
          <h1 class="display-4 mb-3">{% trans "Modifier la Recette" %}</h1>
          <p class="lead text-muted">{% trans "Mettre à jour les informations de" %} <strong>{{ recipe.title }}</strong></p>
        </div>
      </div>
      <div class="col-lg-4 text-lg-end">
        <a href="{% url 'recipe_detail' recipe.id %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-2"></i>{% trans "Retour à la Recette" %}
        </a>
      </div>
    </div>
  </div>

  <!-- Form Section -->
  <div class="form-section">
    <div class="row">
      <div class="col-lg-10 mx-auto">
        <div class="form-card">
          <div class="form-header">
            <div class="form-icon">
              <i class="fas fa-utensils"></i>
            </div>
            <h3>{% trans "Détails de la Recette" %}</h3>
            <p class="text-muted">{% trans "Modifiez les informations de votre recette" %}</p>
          </div>
          
          <form method="post" enctype="multipart/form-data" class="form-modern">
            {% csrf_token %}
            
            {% if errors %}
            <div class="alert alert-danger mb-4">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>{% trans "Erreurs détectées :" %}</strong>
              <ul class="mb-0 mt-2">
                {% for error in errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            
            <!-- Basic Information -->
            <div class="section-header">
              <h4><i class="fas fa-info-circle me-2"></i>{% trans "Informations Générales" %}</h4>
              <hr>
            </div>
            
            <div class="row">
              <div class="col-md-12 mb-4">
                <label for="title" class="form-label">
                  <i class="fas fa-heading me-2"></i>{% trans "Titre de la Recette" %}
                </label>
                <input type="text" 
                       class="form-control form-control-lg" 
                       id="title" 
                       name="title" 
                       value="{{ title|default:recipe.title }}"
                       placeholder="{% trans "Donnez un nom délicieux à votre recette..." %}"
                       required>
                <div class="form-help">
                  <small class="text-muted">
                    <i class="fas fa-lightbulb me-1"></i>
                    {% trans "Choisissez un titre accrocheur et descriptif" %}
                  </small>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12 mb-4">
                <label for="description" class="form-label">
                  <i class="fas fa-align-left me-2"></i>{% trans "Description" %}
                </label>
                <textarea class="form-control" 
                          id="description" 
                          name="description" 
                          rows="3" 
                          placeholder="{% trans "Décrivez votre recette en quelques mots..." %}"
                          required>{{ description|default:recipe.description }}</textarea>
                <div class="form-help">
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Une description appétissante qui donne envie d'essayer la recette" %}
                  </small>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12 mb-4">
                <label for="instructions" class="form-label">
                  <i class="fas fa-list-ol me-2"></i>{% trans "Instructions de Préparation" %}
                </label>
                <textarea class="form-control" 
                          id="instructions" 
                          name="instructions" 
                          rows="6" 
                          placeholder="{% trans "1. Commencez par...&#10;2. Ensuite...&#10;3. Finalement..." %}"
                          required>{{ instructions|default:recipe.instructions }}</textarea>
                <div class="form-help">
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Détaillez chaque étape de préparation de manière claire et ordonnée" %}
                  </small>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12 mb-4">
                <label for="image" class="form-label">
                  <i class="fas fa-camera me-2"></i>{% trans "Image de la Recette" %}
                </label>
                {% if recipe.image %}
                <div class="current-image mb-3">
                  <p class="small text-muted mb-2">
                    <i class="fas fa-image me-1"></i>{% trans "Image actuelle :" %}
                  </p>
                  <div class="current-image-preview">
                    <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                  </div>
                </div>
                {% endif %}
                <input type="file" 
                       class="form-control" 
                       id="image" 
                       name="image" 
                       accept="image/*"
                       placeholder="{% trans "Choisir une nouvelle image..." %}">
                <div class="form-help">
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    {% if recipe.image %}
                    {% trans "Choisissez une nouvelle image pour remplacer l'actuelle (optionnel)" %}
                    {% else %}
                    {% trans "Ajoutez une photo appétissante de votre plat (optionnel)" %}
                    {% endif %}
                  </small>
                </div>
              </div>
            </div>

            <!-- Ingredients Section -->
            <div class="section-header mt-4">
              <h4><i class="fas fa-carrot me-2"></i>{% trans "Ingrédients et Quantités" %}</h4>
              <hr>
            </div>
            
            <div class="ingredients-selection">
              <div class="selection-help mb-3">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>{% trans "Instructions :" %}</strong> {% trans "Cochez les ingrédients nécessaires et spécifiez les quantités et unités pour chacun." %}
                </div>
              </div>
              
              <div class="ingredients-grid">
                {% for ingredient in ingredients %}
                  {% with ri=ri_dict|get_item:ingredient.id %}
                  <div class="ingredient-item">
                    <div class="ingredient-card-selection">
                      <div class="ingredient-check">
                        <input type="checkbox"
                               id="ingredient{{ forloop.counter }}"
                               name="ingredient_ids"
                               value="{{ ingredient.id }}"
                               class="form-check-input"
                               {% if ri %}checked{% endif %}>
                        <label for="ingredient{{ forloop.counter }}" class="form-check-label ingredient-name">
                          <i class="fas fa-leaf me-2"></i>{{ ingredient.name }}
                        </label>
                      </div>
                      
                      <div class="ingredient-details">
                        <div class="row g-2">
                          <div class="col-6">
                            <label class="form-label small">{% trans "Quantité" %}</label>
                            <input type="number" 
                                   name="quantity_{{ ingredient.id }}" 
                                   class="form-control form-control-sm" 
                                   min="0.01" 
                                   step="any" 
                                   value="{{ ri.quantity_str|default_if_none:'' }}"
                                   placeholder="{% trans "0.0" %}">
                          </div>
                          <div class="col-6">
                            <label class="form-label small">{% trans "Unité" %}</label>
                            <select name="unit_{{ ingredient.id }}" class="form-select form-select-sm">
                              {% for unit in units %}
                                <option value="{{ unit.id }}" {% if ri and ri.unit.id == unit.id %}selected{% endif %}>
                                  {{ unit.unit }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endwith %}
                {% endfor %}
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions mt-5">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-2"></i>{% trans "Enregistrer les Modifications" %}
              </button>
              <a href="{% url 'recipe_detail' recipe.id %}" class="btn btn-outline-secondary btn-lg ms-3">
                <i class="fas fa-times me-2"></i>{% trans "Annuler" %}
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Tips Section -->
  <div class="tips-section mt-5">
    <div class="row">
      <div class="col-lg-10 mx-auto">
        <div class="tips-card">
          <h4><i class="fas fa-lightbulb me-2 text-warning"></i>{% trans "Conseils pour une Excellente Recette" %}</h4>
          <div class="row g-3 mt-2">
            <div class="col-md-3">
              <div class="tip-item">
                <i class="fas fa-clock me-2 text-primary"></i>
                <small>{% trans "Précisez les temps de préparation et cuisson" %}</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="tip-item">
                <i class="fas fa-thermometer-half me-2 text-danger"></i>
                <small>{% trans "Indiquez les températures de cuisson" %}</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="tip-item">
                <i class="fas fa-users me-2 text-success"></i>
                <small>{% trans "Précisez le nombre de portions" %}</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="tip-item">
                <i class="fas fa-star me-2 text-warning"></i>
                <small>{% trans "Ajoutez des astuces personnelles" %}</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Gestion de la sélection visuelle des ingrédients
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[name="ingredient_ids"]');
    
    checkboxes.forEach(function(checkbox) {
        const ingredientItem = checkbox.closest('.ingredient-item');
        
        // État initial
        updateIngredientStyle(checkbox, ingredientItem);
        
        // Écouter les changements
        checkbox.addEventListener('change', function() {
            updateIngredientStyle(checkbox, ingredientItem);
        });
    });
    
    function updateIngredientStyle(checkbox, ingredientItem) {
        if (checkbox.checked) {
            ingredientItem.classList.add('ingredient-selected');
        } else {
            ingredientItem.classList.remove('ingredient-selected');
        }
    }
});
</script>
{% endblock %}
